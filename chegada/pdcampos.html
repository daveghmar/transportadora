<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contador Pdcampos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #007bff, #00b4d8);
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 30px;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }
    input {
      text-align: center;
      font-size: 1.2rem;
    }
    table {
      background: white;
      color: black;
      border-radius: 10px;
      overflow: hidden;
      th:nth-child(1) { width: 50px; text-align: center; }
      th:nth-child(2) { width: auto; }
      th:nth-child(3) { width: 120px; text-align: center; } /* hora */
      th:nth-child(4) { width: 90px; text-align: center; }
    }
    .btn {
      border-radius: 50px;
    }
    .botao-voltar {
     position: fixed;
     top: 15px;
     left: 15px;
     background: linear-gradient(135deg, #007bff, #00b4d8);
     color: white;
     text-decoration: none;
     font-weight: 600;
     padding: 10px 18px;
     border-radius: 25px;
     box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
     transition: all 0.25s ease;
     z-index: 1000;
    }
    .botao-voltar:hover {
     background: linear-gradient(135deg, #00b4d8, #007bff);
     transform: translateY(-2px);
     box-shadow: 0 6px 15px rgba(0, 0, 0, 0.35);
    }
  </style>
</head>
<body>

<a href="chegada.html" class="botao-voltar">‚¨ÖÔ∏è Voltar ao In√≠cio</a>
    
<div class="container text-center">
  <h2 class="mb-3">üì¶ Contagem Pdcampos</h2>
  <input id="barcodeInput" type="text" class="form-control mb-3" placeholder="C√≥digo aqui" autofocus>

  <h4 class="mb-3">Total de C√≥digos: <span id="total">0</span></h4>

  <div class="d-flex justify-content-center gap-2 mb-3">
    <button class="btn btn-success" onclick="exportarExcel()">üìä Exportar Excel</button>
    <button class="btn btn-danger" onclick="limpar()">üóëÔ∏è Limpar Tudo</button>
  </div>

  <table class="table table-sm table-bordered">
    <thead class="table-light">
      <tr>
        <th>#</th>
        <th>C√≥digo</th>
        <th>Hora</th> <!-- NOVA COLUNA -->
        <th>‚ùå</th>
      </tr>
    </thead>
    <tbody id="tabela"></tbody>
  </table>
</div>

<script>
  const input = document.getElementById('barcodeInput');
  const tabela = document.getElementById('tabela');
  const total = document.getElementById('total');

  // Agora salva objetos, n√£o apenas strings
  let codigosA = JSON.parse(localStorage.getItem('codigos_pdcamposp') || '[]');

  atualizarTela();

  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const codigo = input.value.trim();

      if (codigo && !codigosA.some(item => item.codigo === codigo)) {

        // üïí pegar hora atual
        const hora = new Date().toLocaleTimeString('pt-BR');

        codigosA.push({ codigo, hora }); // salva c√≥digo + hora
        salvar();
        atualizarTela();
      }

      input.value = '';
    }
  });

  function salvar() {
    localStorage.setItem('codigos_pdcamposp', JSON.stringify(codigosA));
  }

  function atualizarTela() {
    tabela.innerHTML = '';
    codigosA.forEach((item, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i + 1}</td>
        <td>${item.codigo}</td>
        <td>${item.hora}</td>
        <td>
          <button class="btn btn-sm btn-danger" onclick="limparcod(${i})">Excluir</button>
        </td>`;
      tabela.appendChild(tr);
    });
    total.textContent = codigosA.length;
  }

  function limparcod(index) {
    if (confirm('Tem certeza que deseja remover este c√≥digo?')) {
      codigosA.splice(index, 1);
      salvar();
      atualizarTela();
    }
  }

  function limpar() {
    if (confirm('Tem certeza que deseja limpar todos os c√≥digos?')) {
      codigosA = [];
      salvar();
      atualizarTela();
    }
  }

  function exportarExcel() {
    if (codigosA.length === 0) {
      alert('Nenhum c√≥digo para exportar.');
      return;
    }
    const ws = XLSX.utils.json_to_sheet(
      codigosA.map((c, i) => ({ N¬∫: i + 1, C√≥digo: c.codigo, Hora: c.hora }))
    );
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Adidas");
    
    XLSX.writeFile(wb, `adidas_${new Date().toLocaleDateString('pt-BR')}.xlsx`);
  }

  window.addEventListener('click', () => input.focus());

         // ===== FLASH VERDE GLOBAL (todas as telas) =====
  function flashVerde() {
    // evita empilhar flashes
    const existente = document.getElementById("flash-verde-overlay");
    if (existente) existente.remove();

    const div = document.createElement("div");
    div.id = "flash-verde-overlay";
    div.style.position = "fixed";
    div.style.inset = "0";
    div.style.background = "rgba(150, 255, 10, 0.55)";
    div.style.zIndex = "999999";
    div.style.pointerEvents = "none";
    div.style.opacity = "100%";
    div.style.transition = "opacity 1ms ease";

    document.body.appendChild(div);

    // liga
    requestAnimationFrame(() => {
      div.style.opacity = "1";
      // desliga
      setTimeout(() => {
        div.style.opacity = "0";
        setTimeout(() => div.remove(), 180);
      }, 180);
    });
  }

  // Evento que avisa OUTRAS telas (abas/janelas) quando um c√≥digo foi contabilizado
  const FLASH_KEY = "flash_scan_event_v1";

  function dispararFlashGlobal(marca, codigo) {
    // pisca na aba atual
    flashVerde();

    // grava um "evento" no localStorage -> outras abas recebem via "storage"
    const payload = {
      t: Date.now(),
      marca: marca || null,
      codigo: codigo || null
    };
    localStorage.setItem(FLASH_KEY, JSON.stringify(payload));
  }

  // outras abas/janelas abertas recebem aqui e piscam
  window.addEventListener("storage", (e) => {
    if (e.key === FLASH_KEY) {
      flashVerde();
    }
  });

  // opcional: ao voltar pra aba (foco), se teve scan recente, pisca
  window.addEventListener("focus", () => {
    try {
      const raw = localStorage.getItem(FLASH_KEY);
      if (!raw) return;
      const evt = JSON.parse(raw);
      if (evt && evt.t && (Date.now() - evt.t) < 1500) {
        flashVerde();
      }
    } catch {}
  });
</script>

</body>
</html>
